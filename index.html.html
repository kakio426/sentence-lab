<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>문장연습실 — 띄어쓰기·받아쓰기 세트</title>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js" crossorigin="anonymous"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0b1020;--bg-2:#0f172a;--card:#0c1426;--line:#223153;--text:#e5e7eb;--muted:#94a3b8;--accent:#7c3aed;--accent-2:#06b6d4;--ok:#22c55e;--warn:#ef4444;--shadow:0 12px 32px rgba(0,0,0,.35)}
  *{box-sizing:border-box}
  body{margin:0;font-family:Pretendard,ui-sans-serif,system-ui,-apple-system,"Apple SD Gothic Neo","Malgun Gothic",Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,var(--bg) 0%,var(--bg-2) 60%,var(--bg-2) 100%);color:var(--text)}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,rgba(124,58,237,.14),rgba(6,182,212,.14));backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--line)}
  .wrap{max-width:1080px;margin:0 auto;padding:16px}
  h1{margin:0;font-size:22px;display:flex;gap:10px;align-items:center}
  .brand{padding:6px 10px;border-radius:12px;background:rgba(124,58,237,.15);border:1px solid rgba(124,58,237,.35)}
  .seg{display:flex;gap:8px}
  .seg a{display:inline-block;padding:8px 14px;border-radius:999px;color:var(--text);text-decoration:none;border:1px solid var(--line)}
  .seg a.on{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,.25)}
  main{max-width:1080px;margin:0 auto;padding:24px 16px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  .card{background:linear-gradient(180deg,rgba(13,20,40,.92),rgba(11,17,33,.92));border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
  .card h2{margin:0 0 8px 0}
  textarea,input[type=text]{width:100%;padding:12px;border:1px solid #27324b;background:#0b1121;color:var(--text);border-radius:12px;font:inherit}
  textarea{min-height:120px}
  button{border:1px solid #27324b;background:linear-gradient(180deg,#101933,#0c142a);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font:inherit}
  button.primary{border-color:transparent;background:linear-gradient(90deg,var(--accent),var(--accent-2))}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted);font-size:12px}
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace;white-space:pre-wrap}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0b1222}
  .qr{display:grid;place-items:center;width:200px;height:200px;border-radius:16px;background:#0a1224;border:1px dashed #24304a}
  mark{background:#fde68a33;border:1px solid #fde68a55;border-radius:4px;padding:0 2px}
  .ok{color:var(--ok)} .warn{color:var(--warn)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #223153;padding:8px;vertical-align:top}
  th{text-align:left;color:#cbd5e1}
  tr:hover{background:#0f1a35}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  .toggle{display:inline-flex;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1222}
  .toggle button{background:transparent;border:0;margin:0;padding:6px 10px;color:var(--muted);cursor:pointer}
  .toggle button.on{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}
  .pin{display:inline-flex;gap:6px;align-items:center;margin-left:8px}
  .pin input{width:120px}
  .note{font-size:12px;color:#fbbf24;margin-left:8px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1><span class="brand">문장연습실</span> <span class="muted">— 띄어쓰기·받아쓰기 세트</span></h1>
    <div class="seg">
      <a id="btnTeacher" href="#" class="on">교사</a>
      <a id="btnStudent" href="#">학생</a>
    </div>
  </div>
</header>
<main class="wrap" id="app"></main>
<footer class="wrap muted">
  <p>LanguageTool 공개 API(ko) 사용. Firebase·QR은 선택 기능입니다.</p>
</footer>
<script>
(function(){'use strict';
// ===== Query & Utils =====
var qs=new URLSearchParams(location.search);
var role=qs.get('role')||'teacher';
var mode=qs.get('mode')||'spacing'; // spacing | dictate (학생용)
var setParam=qs.get('set')||''; // base64(JSON array)
var cfgParam=qs.get('cfg')||''; // base64(firebase config JSON)
var lock=(qs.get('lock')||'')==='1'; // 학생링크 잠금
var session=qs.get('session')||rndSession();

// 학생 링크 잠금: lock=1 이고 role!=student면 강제 학생화면으로 전환
if(lock && role!=='student'){
  role='student';
  try{ var p=new URLSearchParams(location.search); p.set('role','student'); p.set('mode','spacing'); history.replaceState(null,'',location.pathname+'?'+p.toString()); }catch(e){}
}

function $(s,el){return (el||document).querySelector(s);} function esc(s){return String(s).replace(/[&<>"']/g,function(m){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]);});}
function toast(msg){var t=document.createElement('div');t.textContent=msg;Object.assign(t.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',background:'#0b1222',border:'1px solid #223153',padding:'8px 12px',borderRadius:'10px',zIndex:999,color:'#e5e7eb'});document.body.appendChild(t);setTimeout(function(){try{t.remove();}catch(e){t.parentNode&&t.parentNode.removeChild(t);}},1500);} 
function rndSession(){return Math.random().toString(36).slice(2,8).toUpperCase();}
function originSafe(){return(location.origin&&location.origin!=='null')?location.origin:'';}
function updateParam(obj){var p=new URLSearchParams(location.search);Object.keys(obj).forEach(function(k){p.set(k,obj[k]);});return location.pathname+'?'+p.toString();}
function b64enc(str){return btoa(unescape(encodeURIComponent(str)));} function b64dec(b){try{return decodeURIComponent(escape(atob(b)));}catch(e){return ''}}
function diffHL(a,b){var ta=a.split(/(\s+)/),tb=b.split(/(\s+)/);var L=Math.max(ta.length,tb.length),out='';for(var i=0;i<L;i++){var ca=ta[i]||'',cb=tb[i]||'';out+=(ca===cb?esc(cb):'<mark>'+esc(cb)+'</mark>')}return out;}

// ===== Firebase (optional) =====
var db=null,fbReady=false;function loadCfg(){try{return JSON.parse(localStorage.getItem('fb_config')||'null');}catch(e){return null;}}
function fbAvail(){return typeof window!=='undefined'&&window.firebase;}
function initFb(){var c=loadCfg();if(!c&&cfgParam){try{c=JSON.parse(b64dec(cfgParam));localStorage.setItem('fb_config',JSON.stringify(c));}catch(e){}}
  if(!c||!fbAvail()){fbReady=false;db=null;return Promise.resolve(false);}try{var app=(firebase.apps&&firebase.apps.length)?firebase.apps[0]:firebase.initializeApp(c);db=firebase.firestore(app);fbReady=true;return Promise.resolve(true);}catch(e){console.warn(e);fbReady=false;db=null;return Promise.resolve(false);} }

// ===== Header role tabs =====
var tBtn=document.getElementById('btnTeacher'), sBtn=document.getElementById('btnStudent');
function setRoleUI(){if(!tBtn||!sBtn)return; if(role==='teacher'){tBtn.classList.add('on');sBtn.classList.remove('on');}else{sBtn.classList.add('on');tBtn.classList.remove('on');}
  // 학생 링크(lock=1)에서는 교사 탭 자체를 숨김
  if(lock){ tBtn.style.display='none'; sBtn.classList.add('on'); }
  tBtn.href=updateParam({role:'teacher'}); sBtn.href=updateParam({role:'student',mode:'spacing',lock: lock?'1':'0'});
}
setRoleUI();
if(role==='teacher') renderTeacher(); else renderStudent();

// ===== Teacher =====
function renderTeacher(){initFb().then(function(){var app=document.getElementById('app');if(!app)return;app.innerHTML=[
  '<div class="grid">',
    '<div class="card">',
      '<h2>띄어쓰기 문제 만들기</h2>',
      '<p class="muted">문장을 한 줄에 하나씩 입력하세요. 학생은 한 번 접속해 <b>처음→끝</b>까지 풉니다.</p>',
      '<textarea id="spacingLines" placeholder="예: \n오늘은 비가 옵니다.\n나는 책을 읽었습니다."></textarea>',
      '<div class="row"><button id="makeSpacing" class="primary">학생 링크 생성</button><span class="pill">세션 <b>'+esc(session)+'</b></span></div>',
      '<div class="row" style="margin-top:10px"><div id="qrSpacing" class="qr"></div><div style="min-width:260px"><div class="muted">학생 링크</div><input id="linkSpacing" type="text" readonly /><div class="row" style="margin-top:8px"><button id="copySpacing">복사</button><button id="openSpacing">새 창으로</button></div></div></div>',
    '</div>',
    '<div class="card">',
      '<h2>받아쓰기 세트 만들기</h2>',
      '<p class="muted">받아쓸 문장을 한 줄에 하나씩 입력하세요. 학생은 각 문항을 듣고 입력합니다.</p>',
      '<textarea id="dictLines" placeholder="예: \n나는 오늘 학교에 갔습니다.\n점심시간에 축구를 했습니다."></textarea>',
      '<div class="row"><button id="makeDict" class="primary">학생 링크 생성</button><span class="pill">세션 <b>'+esc(session)+'</b></span></div>',
      '<div class="row" style="margin-top:10px"><div id="qrDict" class="qr"></div><div style="min-width:260px"><div class="muted">학생 링크</div><input id="linkDict" type="text" readonly /><div class="row" style="margin-top:8px"><button id="copyDict">복사</button><button id="openDict">새 창으로</button></div></div></div>',
      '<div class="muted" id="dictHint">'+(fbReady? 'Firebase 연결됨: 링크가 짧게 생성됩니다.' : 'Firebase 미사용: 세트가 링크에 포함됩니다.')+'</div>',
    '</div>',
  '</div>',
  '<div class="card" style="margin-top:16px">',
    '<div class="row" style="justify-content:space-between;align-items:center">',
      '<h2 style="margin:0">결과 수집(선택)</h2>',
      '<div class="row">',
        '<div class="toggle" title="보기 범위">',
          '<button id="viewCur" class="on">현재 세션</button>',
          '<button id="viewAll">모든 세션</button>',
        '</div>',
        '<div class="pin">',
          '<input id="pinInput" type="text" placeholder="세션 입력" />',
          '<button id="pinBtn">세션 고정</button>',
        '</div>',
        '<div id="fbStatus" style="margin-left:8px"></div>',
      '</div>',
    '</div>',
    '<div class="note" id="idxNote" style="display:none"></div>',
    '<table style="margin-top:8px"><thead><tr><th>시간</th><th>세션</th><th>모드</th><th>닉네임</th><th>점수</th><th>총문항</th></tr></thead><tbody id="tbody"><tr><td colspan="6" class="muted">대기 중…</td></tr></tbody></table>',
  '</div>',
  '<div class="card" style="margin-top:16px">',
    '<h2 style="margin:0">Firebase 설정(JSON)</h2>',
    '<p class="muted">붙여 넣고 저장하면 실시간 수집/짧은 링크가 활성화됩니다.</p>',
    '<textarea id="fbJson" placeholder='+JSON.stringify('{"apiKey":"","authDomain":"","projectId":"" ... }')+'></textarea>',
    '<div class="row" style="margin-top:8px"><button id="saveFb" class="primary">설정 저장</button><button id="clearFb">설정 삭제</button><button id="diag">진단</button></div>',
  '</div>'
].join('');

  function setDocPath(){return db? db.collection('sets').doc(session): null;}
  function linkBase(m,extra){extra=extra||{};var u=new URL(location.href);u.searchParams.set('role','student');u.searchParams.set('mode',m);u.searchParams.set('session',session);u.searchParams.set('lock','1');Object.keys(extra).forEach(function(k){u.searchParams.set(k,extra[k]);});return u.pathname+'?'+u.searchParams.toString();}
  function buildLink(items, m){ if(fbReady&&db){ var ref=setDocPath(); var payload={ts:Date.now()}; payload[m]=items; ref.set(payload,{merge:true}).catch(function(){}); var cfg=loadCfg(); return linkBase(m,{ cfg: b64enc(JSON.stringify(cfg||{})) }); } else { var enc=b64enc(JSON.stringify(items)); return linkBase(m,{set:enc}); } }
  function setQR(id,link){ var q=$(id); q.innerHTML=''; if(window.QRCode){ new QRCode(q,{text:originSafe()+link,width:200,height:200}); } }

  // 띄어쓰기
  $('#makeSpacing').addEventListener('click', function(){ var arr=($('#spacingLines').value||'').split(/\n+/).map(function(s){return s.trim();}).filter(Boolean); if(!arr.length){alert('문장을 입력하세요');return;} var link=buildLink(arr,'spacing'); $('#linkSpacing').value=link; setQR('#qrSpacing',link); });
  $('#copySpacing').addEventListener('click', function(){ var v=$('#linkSpacing').value; if(v){navigator.clipboard&&navigator.clipboard.writeText(v).then(function(){toast('복사 완료');}).catch(function(){prompt('복사하세요',v);});} });
  $('#openSpacing').addEventListener('click', function(){ var v=$('#linkSpacing').value; if(v) window.open(v,'_blank'); });

  // 받아쓰기
  $('#makeDict').addEventListener('click', function(){ var arr=($('#dictLines').value||'').split(/\n+/).map(function(s){return s.trim();}).filter(Boolean); if(!arr.length){alert('문장을 입력하세요');return;} var link=buildLink(arr,'dictate'); $('#linkDict').value=link; setQR('#qrDict',link); });
  $('#copyDict').addEventListener('click', function(){ var v=$('#linkDict').value; if(v){navigator.clipboard&&navigator.clipboard.writeText(v).then(function(){toast('복사 완료');}).catch(function(){prompt('복사하세요',v);});} });
  $('#openDict').addEventListener('click', function(){ var v=$('#linkDict').value; if(v) window.open(v,'_blank'); });

  // 결과 표 — 세션 토글 & 핀 + 인덱스 자동 우회
  var filterAll=false; var unsub=null; var tb=$('#tbody'); var idxNote=$('#idxNote');
  function setIdxNote(show, link){ if(!idxNote) return; if(show){ idxNote.style.display='block'; idxNote.innerHTML='⚠️ 인덱스가 없어 임시 모드로 표시 중입니다. '+(link?('<a href="'+esc(link)+'" target="_blank" rel="noopener">여기</a>에서 한 번 생성하세요.'):'' )+' (완료까지 보통 10–60초)'; } else { idxNote.style.display='none'; idxNote.textContent=''; } }

  function listenAll(){ var q=db.collection('quiz_submits').orderBy('ts','desc').limit(200); unsub=q.onSnapshot(renderRows, onErr); }
  function listenCurrentIndexed(){ var q=db.collection('quiz_submits').where('session','==',session).orderBy('ts','desc').limit(200); unsub=q.onSnapshot(renderRows, function(err){ if(err&&String(err.message||'').indexOf('requires an index')>-1){ var m=String(err.message||''); var link=(m.match(/https?:\/\/[^\s]+/i)||[])[0]||''; setIdxNote(true, link); listenCurrentFallback(); } else { onErr(err); } }); }
  function listenCurrentFallback(){ try{ if(unsub){unsub();unsub=null;} var q=db.collection('quiz_submits').where('session','==',session).limit(200); unsub=q.onSnapshot(function(snap){ if(!snap||snap.empty){ tb.innerHTML='<tr><td colspan="6" class="muted">제출 없음</td></tr>'; return; } var arr=[]; snap.docs.forEach(function(d){ arr.push(d.data()); }); arr.sort(function(a,b){ return (b.ts||0)-(a.ts||0); }); tb.innerHTML=arr.map(rowHtml).join(''); }, onErr); }catch(e){ onErr(e); }
  }
  function renderRows(snap){ setIdxNote(false,''); if(!snap||snap.empty){ tb.innerHTML='<tr><td colspan="6" class="muted">제출 없음</td></tr>'; return; } var rows=[]; snap.docs.forEach(function(d){ rows.push(rowHtml(d.data())); }); tb.innerHTML=rows.join(''); }
  function rowHtml(v){ return '<tr><td>'+new Date(v.ts||Date.now()).toLocaleTimeString()+'</td><td>'+esc(v.session||'')+'</td><td>'+esc(v.mode||'')+'</td><td>'+esc(v.nick||'')+'</td><td>'+esc(String(v.score||0))+'</td><td>'+esc(String(v.total||0))+'</td></tr>'; }
  function onErr(err){ tb.innerHTML='<tr><td colspan="6" class="muted">오류: '+esc(err&&err.message||'')+'</td></tr>'; }

  function watchTable(){ if(!fbReady||!db){ tb.innerHTML='<tr><td colspan="6" class="muted">수집 비활성</td></tr>'; setIdxNote(false,''); if(unsub){unsub();unsub=null;} return; } if(unsub){unsub();unsub=null;} try{ if(filterAll){ listenAll(); } else { listenCurrentIndexed(); } }catch(e){ onErr(e); }
  }

  function setToggle(){ var cur=$('#viewCur'), all=$('#viewAll'); if(!cur||!all) return; if(filterAll){ all.classList.add('on'); cur.classList.remove('on'); } else { cur.classList.add('on'); all.classList.remove('on'); } }
  $('#viewCur').addEventListener('click', function(){ filterAll=false; setToggle(); watchTable(); });
  $('#viewAll').addEventListener('click', function(){ filterAll=true; setToggle(); watchTable(); });

  // 핀 입력/버튼
  var pinInput=$('#pinInput'); if(pinInput) pinInput.value=session;
  var pinBtn=$('#pinBtn'); if(pinBtn) pinBtn.addEventListener('click', function(){ var v=(pinInput.value||'').trim().toUpperCase(); if(!v){ alert('세션 코드를 입력하세요'); return; } window.location.href = updateParam({role:'teacher',session:v}); });
  if(pinInput) pinInput.addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ $('#pinBtn').click(); }});

  // Firebase 설정
  function showStatus(){ var el=$('#fbStatus'); if(!fbAvail()){ el.innerHTML='<span class="pill">라이브러리 없음</span>'; return; } if(!loadCfg()){ el.innerHTML='<span class="pill">설정 없음</span>'; } else if(fbReady){ el.innerHTML='<span class="pill">연결됨</span>'; } else { el.innerHTML='<span class="pill">연결 실패</span>'; } }
  var fbJson=$('#fbJson'), exist=loadCfg(); if(exist) fbJson.value=JSON.stringify(exist,null,2);
  $('#saveFb').addEventListener('click', function(){ try{ var c=JSON.parse(fbJson.value); localStorage.setItem('fb_config',JSON.stringify(c)); toast('저장됨, 재연결 중'); initFb().then(function(){ showStatus(); watchTable(); }); }catch(e){ alert('JSON 형식 오류'); } });
  $('#clearFb').addEventListener('click', function(){ localStorage.removeItem('fb_config'); fbReady=false; db=null; toast('삭제됨'); showStatus(); watchTable(); });
  $('#diag').addEventListener('click', runDiag);

  showStatus(); setToggle(); watchTable();
});}

// ===== Student =====
function renderStudent(){ var app=document.getElementById('app'); if(!app) return; app.innerHTML=[
  '<div class="card">',
  '  <div class="row" style="justify-content:space-between"><h2 style="margin:0">'+(mode==='spacing'?'띄어쓰기 세트':'받아쓰기 세트')+'</h2><span class="pill">세션 <b>'+esc(session)+'</b></span></div>',
  '  <div class="row" style="margin-top:8px"><input id="nick" type="text" placeholder="닉네임(선택)" /></div>',
  '  <div id="stage" style="margin-top:8px"></div>',
  '</div>'
].join('');
  initFb().then(function(){ loadSet().then(function(items){ if(!items||!items.length){ $('#stage').innerHTML='<div class="muted">문항을 불러오지 못했습니다.</div>'; return; } startQuiz(items); }).catch(function(){ $('#stage').innerHTML='<div class="muted">세트를 불러오는 중 오류</div>'; }); });

  function loadSet(){ if(setParam){ try{ var arr=JSON.parse(b64dec(setParam)); if(Array.isArray(arr)&&arr.length) return Promise.resolve(arr); }catch(e){} }
    if(fbReady&&db){ return db.collection('sets').doc(session).get().then(function(s){ var d=s&&s.data&&s.data(); if(!d) return []; return (mode==='spacing'? (d.spacing||[]) : (d.dictate||[])); }); }
    return Promise.resolve([]); }

  function startQuiz(items){ var i=0,N=items.length; var answers=new Array(N); var root=$('#stage');
    renderQ();
    function renderQ(){ var text=items[i]; root.innerHTML=[
      '<div class="pill">문항 <b>'+(i+1)+'</b> / '+N+'</div>',
      (mode==='spacing'? '<p class="muted" style="margin:8px 0">아래 문장을 올바르게 띄어쓰기 하세요.</p>' : '<p class="muted" style="margin:8px 0">문장을 듣고 받아쓰세요.</p>'),
      (mode==='spacing'? '<div class="mono" style="font-size:20px">'+esc(text.replace(/\s+/g,''))+'</div>' : '<div class="row"><button id="listen">듣기</button></div>'),
      '<input id="ans" type="text" placeholder="답안을 입력" style="margin-top:8px"/>',
      '<div class="row" style="margin-top:8px">',
        '<button id="prev">이전</button>',
        (i<N-1? '<button id="next" class="primary">다음</button>' : '<button id="finish" class="primary">완료</button>'),
      '</div>'
    ].join('');
      if(mode==='dictate'){ var btn=$('#listen'); if(btn){ btn.addEventListener('click', function(){ if(!('speechSynthesis' in window)){ alert('이 브라우저는 음성 합성을 지원하지 않습니다'); return; } var u=new SpeechSynthesisUtterance(text); u.lang='ko-KR'; speechSynthesis.speak(u); }); } }
      var ans=$('#ans'); if(answers[i]) ans.value=answers[i]; ans.focus(); ans.addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ (i<N-1? $('#next') : $('#finish')).click(); }});
      $('#prev').disabled=(i===0); $('#prev').onclick=function(){ answers[i]=ans.value.trim(); if(i>0){ i--; renderQ(); } };
      var nextBtn=$('#next'); if(nextBtn) nextBtn.onclick=function(){ answers[i]=ans.value.trim(); if(i<N-1){ i++; renderQ(); } };
      var finBtn=$('#finish'); if(finBtn) finBtn.onclick=function(){ answers[i]=ans.value.trim(); renderResult(items,answers); };
    }
  }

  function renderResult(items,answers){ var N=items.length; var correct=0; var rows=[]; for(var k=0;k<N;k++){ var gold=(items[k]||'').trim(); var a=(answers[k]||'').trim(); var ok = (gold===a); if(ok) correct++; rows.push('<tr><td>'+(k+1)+'</td><td class="mono">'+esc(gold)+'</td><td class="mono">'+esc(a||'(미응답)')+'</td><td>'+(ok?'<span class="ok">정답</span>':'<span class="warn">오답</span>')+'</td></tr>'); }
    $('#stage').innerHTML=[
      '<h3 style="margin:0 0 8px 0">결과</h3>',
      '<div class="pill">점수 <b>'+correct+'</b> / '+N+' <span class="muted">(정확 일치 기준)</span></div>',
      '<div class="row" style="margin-top:8px">'+(fbReady?'<button id="submitAll" class="primary">결과 제출</button>':'')+'<button id="csv">CSV 저장</button><button id="review">정답과 비교</button></div>',
      '<table style="margin-top:12px"><thead><tr><th>#</th><th>정답</th><th>내 답</th><th>채점</th></tr></thead><tbody>'+rows.join('')+'</tbody></table>'
    ].join('');

    $('#review').onclick=function(){ var blocks=[]; for(var k=0;k<N;k++){ var gold=items[k].trim(); var a=(answers[k]||'').trim(); blocks.push('<div class="card" style="margin-top:12px"><div class="pill">문항 '+(k+1)+'</div><div class="mono" style="margin-top:8px">'+diffHL(gold,a||'')+'</div><div class="muted" style="margin-top:4px">노란 부분이 차이입니다.</div></div>'); } $('#stage').innerHTML='<h3 style="margin:0">문항별 비교</h3>'+blocks.join(''); };

    $('#csv').onclick=function(){ var csv='index,answer,student\n'; for(var k=0;k<N;k++){ var g=(items[k]||'').replace(/"/g,'""'); var a=(answers[k]||'').replace(/"/g,'""'); csv+=(k+1)+',"'+g+'","'+a+'"\n'; } var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='result_'+session+'_'+mode+'.csv'; a.click(); URL.revokeObjectURL(url); };

    if(fbReady&&db){ $('#submitAll').onclick=function(){ var nick=($('#nick')&&$('#nick').value)||''; db.collection('quiz_submits').add({ session:session, mode:mode, nick:nick, score:correct, total:N, items:items, answers:answers, ts:Date.now() }).then(function(){ toast('제출 완료'); }).catch(function(e){ alert('제출 실패: '+e.message); }); } }
  }
}

// ===== Diagnostics =====
function runDiag(){ var fails=[]; function ok(n,c){ if(!c) fails.push(n); }
  var arr=['가 나','다 라']; var enc=b64enc(JSON.stringify(arr)); var dec=JSON.parse(b64dec(enc)||'[]'); ok('b64 roundtrip', Array.isArray(dec)&&dec.length===2&&dec[0]===arr[0]);
  ok('spacing view removes spaces', '가나' === arr[0].replace(/\s+/g,''));
  ok('exact scoring false when missing space', (arr[0].trim() === '가나') === false);
  alert(fails.length? ('진단 실패: '+fails.join(', ')) : '진단 통과: 기본 동작 OK'); }

})();
</script>
</body>
</html>

